// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// WPL match and delivery models
model WplMatch {
  id         Int           @id @map("match_id")
  league     String        @default("WPL") @map("league")
  season     String        @map("season")
  startDate  DateTime      @map("start_date")
  venue      String        @map("venue")
  deliveries WplDelivery[]

  @@index([league])
  @@index([league, season])
  @@index([startDate])
  @@index([league, startDate])
  @@map("wpl_match")
}

model WplDelivery {
  id                   Int      @id @default(autoincrement())
  matchId              Int      @map("match_id")
  match                WplMatch @relation(fields: [matchId], references: [id])
  innings              Int      @map("innings")
  ball                 String   @map("ball")
  battingTeam          String   @map("batting_team")
  bowlingTeam          String   @map("bowling_team")
  striker              String   @map("striker")
  nonStriker           String   @map("non_striker")
  bowler               String   @map("bowler")
  runsOffBat           Int      @map("runs_off_bat")
  extras               Int      @map("extras")
  wides                Int      @map("wides")
  noballs              Int      @map("noballs")
  byes                 Int      @map("byes")
  legbyes              Int      @map("legbyes")
  penalty              Int      @map("penalty")
  wicketType           String?  @map("wicket_type")
  playerDismissed      String?  @map("player_dismissed")
  otherWicketType      String?  @map("other_wicket_type")
  otherPlayerDismissed String?  @map("other_player_dismissed")

  @@index([matchId])
  @@index([matchId, innings, ball])
  @@index([striker])
  @@index([bowler])
  @@index([matchId, striker])
  @@index([matchId, bowler])
  @@index([battingTeam])
  @@index([bowlingTeam])
  @@index([matchId, innings])
  @@index([playerDismissed])
  @@index([striker, ball])
  @@index([bowler, ball])
  @@index([matchId, battingTeam])
  @@index([matchId, bowlingTeam])
  @@index([striker, matchId, innings])
  @@index([bowler, matchId, innings])
  @@map("wpl_delivery")
}

// WPL match info model for storing match metadata
model WplMatchInfo {
  id             Int                 @id @map("match_id")
  league         String              @default("WPL") @map("league")
  version        String              @map("version")
  ballsPerOver   Int                 @map("balls_per_over")
  gender         String              @map("gender")
  season         String              @map("season")
  date           DateTime            @map("date")
  event          String              @map("event")
  matchNumber    Int                 @map("match_number")
  venue          String              @map("venue")
  city           String              @map("city")
  tossWinner     String              @map("toss_winner")
  tossDecision   String              @map("toss_decision")
  playerOfMatch  String?             @map("player_of_match")
  winner         String?             @map("winner")
  winnerRuns     Int?                @map("winner_runs")
  winnerWickets  Int?                @map("winner_wickets")
  teams          WplTeam[]
  players        WplPlayer[]
  officials      WplOfficial[]
  peopleRegistry WplPersonRegistry[]

  @@index([league])
  @@index([league, season])
  @@index([winner])
  @@index([date, winner])
  @@map("wpl_match_info")
}

// WPL team model
model WplTeam {
  id        Int          @id @default(autoincrement())
  matchId   Int          @map("match_id")
  teamName  String       @map("team_name")
  matchInfo WplMatchInfo @relation(fields: [matchId], references: [id])

  @@index([matchId, teamName])
  @@map("wpl_team")
}

// WPL player model
model WplPlayer {
  id         Int          @id @default(autoincrement())
  matchId    Int          @map("match_id")
  teamName   String       @map("team_name")
  playerName String       @map("player_name")
  matchInfo  WplMatchInfo @relation(fields: [matchId], references: [id])

  @@index([matchId, teamName])
  @@index([playerName])
  @@index([teamName, playerName])
  @@map("wpl_player")
}

// WPL official model
model WplOfficial {
  id           Int          @id @default(autoincrement())
  matchId      Int          @map("match_id")
  officialType String       @map("official_type") // umpire, reserve_umpire, tv_umpire, match_referee
  officialName String       @map("official_name")
  matchInfo    WplMatchInfo @relation(fields: [matchId], references: [id])

  @@index([matchId, officialType])
  @@map("wpl_official")
}

// WPL people registry model
model WplPersonRegistry {
  id         Int          @id @default(autoincrement())
  matchId    Int          @map("match_id")
  personName String       @map("person_name")
  registryId String       @map("registry_id")
  matchInfo  WplMatchInfo @relation(fields: [matchId], references: [id])

  @@index([matchId, personName])
  @@index([registryId])
  @@map("wpl_person_registry")
}

// AI Chat Request logging model
model AiChatRequest {
  id              String    @id @default(cuid())

  // Request details
  question        String    @map("question")
  sanitizedQuestion String? @map("sanitized_question")
  league          String?   @map("league")

  // Generated SQL
  generatedSql    String?   @map("generated_sql") @db.Text

  // Response metadata
  rowCount        Int?      @map("row_count")
  executionTimeMs Int?      @map("execution_time_ms")

  // Error tracking
  success         Boolean   @default(true)
  errorCode       String?   @map("error_code")
  errorMessage    String?   @map("error_message") @db.Text

  // Accuracy feedback (optional)
  isAccurate      Boolean?  @map("is_accurate")
  feedbackNote    String?   @map("feedback_note") @db.Text
  feedbackAt      DateTime? @map("feedback_at")

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([league])
  @@index([success])
  @@index([isAccurate])
  @@index([createdAt])
  @@map("ai_chat_request")
}
